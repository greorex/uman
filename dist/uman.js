/* @preserve
 * uman, v0.4.3
 * Units manager javascript library to orchestrate web workers
 * (c) 2019-2020 Grigory Schurovski 
 * Released under the Apache-2.0 license
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).uman={})}(this,(function(t){"use strict";const e={EVENT:"event",REQUEST:"request",RESPONSE:"response",RECEIPT:"receipt"},s={ALL:"all",THIS:0};class n{constructor(){return this.options={},this.name="",this.units=this._proxyUnits(),this._unitsProxy={},this._proxyThis()}terminate(){}_proxyThis(){const t={emit:this._emitFunction(s.THIS)};return new Proxy(this,{get:(e,n)=>n in e?e[n]:n in t?t[n]:this._requestFunction(s.THIS,n)})}_proxyTarget(t){const e=this._unitsProxy[t];if(e)return e;const s={emit:this._emitFunction(t)};return this._unitsProxy[t]=new Proxy(s,{get:(e,s)=>s in e?e[s]:this._requestFunction(t,s)})}_proxyUnits(){const t={emit:this._emitFunction(s.ALL)};return new Proxy(t,{get:(t,e)=>e in t?t[e]:this._proxyTarget(e)})}_emitFunction(t){return(s,n)=>this._redispatch({type:e.EVENT,target:t,method:s,payload:n})}_requestFunction(t,s){return(...n)=>this._redispatch({type:e.REQUEST,target:t,method:s,payload:n})}_onevent(t){const{method:e,payload:s,sender:n}=t;if(n){const t=this._unitsProxy[n];if(t){const n=`on${e}`;if(n in t&&t[n](s))return}const i=`on${n}${e}`;if(i in this&&this[i](s))return}const i=`on${e}`;i in this&&this[i](t)}_oncall(t){const{method:e,payload:s}=t;return this[e](...s)}_dispatch(t){switch(t.type){case e.EVENT:return this._onevent(t);case e.REQUEST:return this._oncall(t)}}_redispatch(t){return this._dispatch(t)}}class i extends n{constructor(t){super(),this._c=new Map,this._n=0,this.options.timeout=5e3,this.postMessage=(...e)=>{t.postMessage(...e)},t.onmessage=t=>{this._onmessage(t)}}onmessage(t){}_onmessage(t){const{data:s}=t;if(s instanceof Object)switch(s.type){case e.EVENT:return this._onevent(s);case e.REQUEST:return this._onrequest(s);case e.RESPONSE:return this._onresponse(s);case e.RECEIPT:return this._onreceipt(s)}this.onmessage(t)}_dispatch(t){switch(t.type){case e.EVENT:return this.postMessage(t);case e.REQUEST:return new Promise((e,s)=>{const n={resolve:e,reject:s};t.cid=++this._n,this.options.timeout&&(n.timeout=setTimeout(()=>{this._onresponse({cid:t.cid,error:"Timeout on request "+t.method})},this.options.timeout)),this._c.set(t.cid,n),this.postMessage(t)})}}async _onrequest(t){const s={cid:t.cid};s.type=e.RECEIPT,this.postMessage(s);try{s.result=await this._oncall(t)}catch(t){s.error=t}s.type=e.RESPONSE,this.postMessage(s)}_onresponse(t){const{cid:e,result:s,error:n}=t,i=this._c.get(e);i&&(i.timeout&&clearTimeout(i.timeout),this._c.delete(e),n?i.reject(new Error(n)):i.resolve(s))}_onreceipt(t){const e=this._c.get(t.cid);e&&e.timeout&&clearTimeout(e.timeout)}}class r extends i{constructor(t){super(t),this.terminate=()=>t.terminate()}_onevent(t){return t.target?this._redispatch(t):super._onevent(t)}_oncall(t){return t.target?this._redispatch(t):super._oncall(t)}}class o extends i{constructor(t=self){super(t)}}const c=()=>self&&!self.window&&self.postMessage instanceof Function&&self.importScripts instanceof Function?o:n;class a extends(c()){static instance(t){return c()===o?new t:t}}t.MessageType=e,t.TargetType=s,t.Unit=a,t.UnitBase=n,t.UnitWorker=r,t.UnitWorkerSelf=o,t.UnitsManager=class{constructor(t={}){this._units={},this._copyUnitsEntry(t),this.units=this._proxyUnits()}_proxyUnits(){return new Proxy(this._units,{get:(t,e)=>{const s=t[e];return s instanceof n?s:s instanceof Function?this._attachUnit(e,s):s}})}_attachUnit(t,e){let s;if(e instanceof Function&&(e=e()),e instanceof Worker&&(s=new r(e)),e instanceof Promise&&(s=new n,s._dispatch=async t=>{let n=await e.then();return n.default instanceof Function&&(n=new n.default),n=this._attachUnit(s.name,n),n._dispatch(t)}),s||(s=e),!(s instanceof n))throw new Error("Wrong class of unit: "+t);return s.name=t,s._redispatch=t=>t.target?(t.sender=s.name,this._redispatch(t)):s._dispatch(t),this._units[t]=s}_copyUnitsEntry(t){for(let e of Object.entries(t)){const[t,s]=e;if(this._units[t])throw new Error("Unit "+s+" already exists");if("string"!=typeof t||"emit"===t)throw new Error("Wrong unit name: "+t);if(s instanceof n)this._attachUnit(t,s);else{if(!(s instanceof Function))throw new Error("Wrong unit value: "+s);this._units[t]=s}}}_redispatch(t){const{target:e,sender:i}=t;switch(e){case s.ALL:for(let e of Object.keys(this._units))if(e!==i){const s=this._units[e];s instanceof n&&s._dispatch(t)}return;default:const r=this.units[e];if(r instanceof n)return r._dispatch(t)}throw new Error("Wrong target unit: "+e)}addUnits(t){return this._copyUnitsEntry(t),this}deleteUnit(t){const e=this._units[t];e instanceof n&&e.terminate(),e&&delete this._units[t]}deleteAll(){for(let t of Object.keys(this._units))this.deleteUnit(t)}},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=uman.js.map
